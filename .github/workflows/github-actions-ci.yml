name: CI Build

on:
  push:
    branches:
      - main
    tags:
      - 'v*'  # Push events to matching v*, i.e. v1.0, v20.15.10
  pull_request:
    branches:
      - main

env:
  DOCKER_IMAGE_NAME: ghcr.io/elifesciences/sciencebeam-parser

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Set tags
        id: set_tags
        run: |
          DOCKER_IMAGE="${{ env.DOCKER_IMAGE_NAME }}"
          VERSION=""
          GIT_BRANCH=${GITHUB_BASE_REF:-${GITHUB_REF#refs/heads/}}
          SHORT_SHA=${GITHUB_SHA::8}
          TIMESTAMP=`date --utc +%Y%m%d.%H%M`
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          TAG_LINES=""
          if [[ $VERSION =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
            IMAGE_NAME="${DOCKER_IMAGE}"
            IMAGE_TAG="${VERSION}"
            TAGS="${DOCKER_IMAGE}:${VERSION},${DOCKER_IMAGE}:latest"
            CV_TAGS="${DOCKER_IMAGE}:${VERSION}-cv,${DOCKER_IMAGE}:latest-cv"
          else
            IMAGE_NAME="${DOCKER_IMAGE}_unstable"
            IMAGE_TAG="${GITHUB_SHA}"
            TAGS="${DOCKER_IMAGE}_unstable:${GITHUB_SHA},${DOCKER_IMAGE}_unstable:${GIT_BRANCH}-${SHORT_SHA}-${TIMESTAMP},${DOCKER_IMAGE}_unstable:latest"
            CV_TAGS="${DOCKER_IMAGE}_unstable:${GITHUB_SHA}-cv,${DOCKER_IMAGE}_unstable:${GIT_BRANCH}-${SHORT_SHA}-${TIMESTAMP}-cv,${DOCKER_IMAGE}_unstable:latest-cv"
            TAG_LINES="${TAG_LINES}sciencebeam-parser.tags=${IMAGE_NAME}:${GIT_BRANCH}-${SHORT_SHA}-${TIMESTAMP}\n"
            TAG_LINES="${TAG_LINES}sciencebeam-parser-cv.tags=${IMAGE_NAME}:${GIT_BRANCH}-${SHORT_SHA}-${TIMESTAMP}-cv\n"
          fi
          TAG_LINES="${TAG_LINES}sciencebeam-parser.tags=${IMAGE_NAME}:${IMAGE_TAG}\n"
          TAG_LINES="${TAG_LINES}sciencebeam-parser.tags=${IMAGE_NAME}:latest\n"
          TAG_LINES="${TAG_LINES}sciencebeam-parser-cv.tags=${IMAGE_NAME}:${IMAGE_TAG}-cv\n"
          TAG_LINES="${TAG_LINES}sciencebeam-parser-cv.tags=${IMAGE_NAME}:latest-cv\n"
          TAG_LINES="${TAG_LINES}sciencebeam-parser-dev.tags=${IMAGE_NAME}-dev:${GITHUB_SHA}\n"
          echo -e "tag_lines<<EOF\n${TAG_LINES}EOF" >> $GITHUB_OUTPUT
          DEV_TAG="${IMAGE_NAME}-dev:${GITHUB_SHA}"
          echo "IMAGE_NAME=${IMAGE_NAME}"
          echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "IMAGE_TAG=${IMAGE_TAG}"
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "TAGS=${TAGS}"
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "CV_TAGS=${CV_TAGS}"
          echo "cv_tags=${CV_TAGS}" >> $GITHUB_OUTPUT
          echo "DEV_TAG=${DEV_TAG}"
          echo "dev_tag=${DEV_TAG}" >> $GITHUB_OUTPUT
          echo "VERSION: ${VERSION}"
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Check out repository code
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

    #   - name: Build "dev" (no push)
    #     uses: docker/build-push-action@v6
    #     with:
    #       tags: ${{ steps.set_tags.outputs.dev_tag }}
    #       target: dev
    #       push: false
    #       load: true

    #   - name: Build "runtime" (no push)
    #     uses: docker/build-push-action@v6
    #     with:
    #       tags: ${{ steps.set_tags.outputs.tags }}
    #       target: runtime
    #       push: false
    #       load: true

    #   - name: Build "runtime-cv" (no push)
    #     uses: docker/build-push-action@v6
    #     with:
    #       tags: ${{ steps.set_tags.outputs.cv_tags }}
    #       target: runtime-cv
    #       push: false
    #       load: true

    #   - name: Push "runtime"
    #     uses: docker/build-push-action@v6
    #     with:
    #       tags: ${{ steps.set_tags.outputs.tags }}
    #       target: runtime
    #       push: true
    #       load: false

    #   - name: Push "runtime-cv"
    #     uses: docker/build-push-action@v6
    #     with:
    #       tags: ${{ steps.set_tags.outputs.cv_tags }}
    #       target: runtime-cv
    #       push: true
    #       load: false

      - uses: mtkennerly/dunamai-action@v1
        with:
          env-var: PYTHON_PACKAGE_VERSION
          args: --style semver --no-metadata

      - name: Show determined Python package version
        run: echo $PYTHON_PACKAGE_VERSION

      - name: Bake build for all targets (no push)
        uses: docker/bake-action@v6
        with:
          files: docker-bake.hcl,docker-compose.yml
          targets: python-dist,lint-flake8,lint-pylint,lint-mypy,end-to-end-tests,sciencebeam-parser,sciencebeam-parser-cv
          set: |
            ${{ steps.set_tags.outputs.tag_lines }}
            python-dist.args.python_package_version=$PYTHON_PACKAGE_VERSION
            python-dist.output=type=local,dest=./dist-export
          push: false
          load: false

      - name: List dist-export contents
        run: ls -R -l ./dist-export

      - name: Upload python package artifacts
        uses: actions/upload-artifact@v5
        with:
          name: python-package-distributions
          path: ./dist-export/dist/

    #   - name: Bake build for all targets (no push) v2
    #     uses: docker/bake-action@v6
    #     with:
    #       files: docker-compose.yml
    #       targets: sciencebeam-parser-dev,sciencebeam-parser
    #       set: |
    #         ${{ steps.set_tags.outputs.tag_lines }}
    #       push: false
    #       load: false

    #   - name: Linting
    #     run: make IMAGE_NAME=${{ steps.set_tags.outputs.image_name }} IMAGE_TAG=${{ steps.set_tags.outputs.image_tag }} IMAGE_TAG=${{ github.sha }} ci-lint
    #   - name: Unit Test
    #     run: make IMAGE_NAME=${{ steps.set_tags.outputs.image_name }} IMAGE_TAG=${{ steps.set_tags.outputs.image_tag }} ci-pytest
    #   - name: End-to-end Test
    #     run: make IMAGE_NAME=${{ steps.set_tags.outputs.image_name }} IMAGE_TAG=${{ steps.set_tags.outputs.image_tag }} ci-end-to-end
    #   - name: Push package to test.pypi.org
    #     if: ${{ steps.set_tags.outputs.VERSION == '' }}
    #     run: make IMAGE_NAME=${{ steps.set_tags.outputs.image_name }} IMAGE_TAG=${{ steps.set_tags.outputs.image_tag }} REVISION=${{ github.sha }} ci-push-testpypi
    #     env:
    #       TWINE_PASSWORD: ${{ secrets.TEST_PYPI_CREDENTIALS }}
    #   - name: Push package to pypi.org
    #     if: ${{ steps.set_tags.outputs.VERSION != '' }}
    #     run: make IMAGE_NAME=${{ steps.set_tags.outputs.image_name }} IMAGE_TAG=${{ steps.set_tags.outputs.image_tag }} VERSION=${{ steps.set_tags.outputs.VERSION }} NO_BUILD=y ci-push-pypi
    #     env:
    #       TWINE_PASSWORD: ${{ secrets.PYPI_CREDENTIALS }}

    #   - name: List files changed or added by tests
    #     run: |
    #         echo "Changed or added tracked files (porcelain format):"
    #         git status --porcelain=v2

    #         echo
    #         echo "Untracked files to be deleted by 'git clean --force -d --dry-run --exclude=.git':"
    #         git clean --force -d --dry-run --exclude=.git

    #   - name: Bake push (if not PR)
    #     uses: docker/bake-action@v6
    #     with:
    #       files: docker-compose.yml
    #       targets: sciencebeam-parser,sciencebeam-parser-cv
    #       set: |
    #         ${{ steps.set_tags.outputs.tag_lines }}
    #         *.cache-from=type=gha
    #         *.cache-to=type=gha,mode=max
    #       push: true
    #       load: false
